datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserStatus {
  ONLINE
  INVISIBLE
  IDLE
  DND
}

model User {
  id         BigInt    @id
  username   String    @unique
  globalname String?
  email      String?   @unique
  phone      String?   @unique
  password   String
  avatar     String?
  birthdate  DateTime?
  isBot      Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // relations
  presence     Presence?
  statusRecord UserStatusRecord?

  friendships1 Friendship[] @relation("UserFriend1")
  friendships2 Friendship[] @relation("UserFriend2")

  sourceRelations     UserRelation[]        @relation("SourceUser")
  targetRelations     UserRelation[]        @relation("TargetUser")
  channelRecipients   ChannelRecipient[]
  userSettings        UserSettings?
  channelUserSettings ChannelUserSettings[]

  @@index([username])
}

model Presence {
  id        BigInt      @id
  userId    BigInt      @unique
  user      User        @relation(fields: [userId], references: [id])
  status    UserStatus?
  expiresAt DateTime?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model UserStatusRecord {
  id        BigInt    @id
  userId    BigInt    @unique
  user      User      @relation(fields: [userId], references: [id])
  text      String?
  emoji     String?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Friendship {
  id        BigInt           @id
  user1     User             @relation("UserFriend1", fields: [user1Id], references: [id])
  user1Id   BigInt
  user2     User             @relation("UserFriend2", fields: [user2Id], references: [id])
  user2Id   BigInt
  status    FriendshipStatus @default(PENDING)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
}

model UserRelation {
  id        BigInt       @id
  source    User         @relation("SourceUser", fields: [sourceId], references: [id])
  sourceId  BigInt
  target    User         @relation("TargetUser", fields: [targetId], references: [id])
  targetId  BigInt
  type      RelationType
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  note      String?

  @@unique([sourceId, targetId, type])
  @@index([sourceId])
  @@index([targetId])
}

enum RelationType {
  BLOCKED
  IGNORED
}

model Channel {
  id        BigInt      @id @default(autoincrement())
  type      ChannelType
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  recipients          ChannelRecipient[]
  lastMessageAt       DateTime?
  channelUserSettings ChannelUserSettings[]

  @@index([type])
  @@index([lastMessageAt])
}

enum ChannelType {
  DM
}

model ChannelRecipient {
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  channelId BigInt
  show      Boolean @default(true)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    BigInt

  lastReadMessageId BigInt?
  unreadCount       Int     @default(0)

  @@id([channelId, userId])
  @@index([userId])
}

model UserSettings {
  userId BigInt @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  uiSettingsId BigInt
  uiSettings   UiSettings @relation(fields: [uiSettingsId], references: [id])

  locale String @default("ar")

  channelUserSettings ChannelUserSettings[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UiSettings {
  id           BigInt         @id @default(autoincrement())
  themeId      BigInt
  theme        Theme          @relation(fields: [themeId], references: [id])
  languageId   BigInt
  language     Language       @relation(fields: [languageId], references: [id])
  userSettings UserSettings[]
}

model Theme {
  id    BigInt    @id @default(autoincrement())
  theme ThemeType @default(DARK)

  uiSettings UiSettings[]
}

enum ThemeType {
  DARK
  LIGHT
}

model Language {
  id         BigInt       @id @default(autoincrement())
  language   LanguageType @default(EN)
  uiSettings UiSettings[]
}

enum LanguageType {
  AR
  EN
}

model ChannelUserSettings {
  channelId BigInt
  userId    BigInt

  muted     Boolean   @default(false)
  pinned    Boolean   @default(false)
  muteUntil DateTime?

  userSettings UserSettings @relation(fields: [userId], references: [userId], onDelete: Cascade)
  channel      Channel      @relation(fields: [channelId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@id([channelId, userId])
  @@index([userId])
}
